script:
  hasp_publish_discovery:
    alias: HASP MQTT discovery (3 relays, custom names)
    mode: single
    fields:
      node:
        description: HASP node name (device name)
        example: dash
        default: dash
      relay1_name:
        description: Friendly name for relay 1
        default: relay1
      relay2_name:
        description: Friendly name for relay 2
        default: relay2
      relay3_name:
        description: Friendly name for relay 3
        default: relay3
    sequence:
      - variables:
          node: "{{ node | default('dash') }}"
          base: "hasp/{{ node }}"
          dev_ident: "openhasp_{{ node }}"
          r1: "{{ relay1_name | default('relay1') }}"
          r2: "{{ relay2_name | default('relay2') }}"
          r3: "{{ relay3_name | default('relay3') }}"
      # Relay 1 (GPIO 1 → output1)
      - service: mqtt.publish
        data:
          topic: "homeassistant/switch/{{ node }}_relay1/config"
          retain: true
          payload: >
            {
              "name": "{{ r1 }}",
              "unique_id": "{{ node }}_output1",
              "command_topic": "{{ base }}/command/output1",
              "state_topic":   "{{ base }}/state/output1",
              "value_template": "{{'{{ value_json.state }}'}}",
              "payload_on":  "{\"state\":\"on\"}",
              "payload_off": "{\"state\":\"off\"}",
              "state_on": "on",
              "state_off": "off",
              "optimistic": true,
              "device": {
                "identifiers": ["{{ dev_ident }}"],
                "name": "openHASP {{ node }}",
                "manufacturer": "openHASP",
                "model": "ESP32-S3 480x480"
              }
            }
      # Relay 2 (GPIO 2 → output2)
      - service: mqtt.publish
        data:
          topic: "homeassistant/switch/{{ node }}_relay2/config"
          retain: true
          payload: >
            {
              "name": "{{ r2 }}",
              "unique_id": "{{ node }}_output2",
              "command_topic": "{{ base }}/command/output2",
              "state_topic":   "{{ base }}/state/output2",
              "value_template": "{{'{{ value_json.state }}'}}",
              "payload_on":  "{\"state\":\"on\"}",
              "payload_off": "{\"state\":\"off\"}",
              "state_on": "on",
              "state_off": "off",
              "optimistic": true,
              "device": {
                "identifiers": ["{{ dev_ident }}"],
                "name": "openHASP {{ node }}",
                "manufacturer": "openHASP",
                "model": "ESP32-S3 480x480"
              }
            }
      # Relay 3 (GPIO 40 → output40)
      - service: mqtt.publish
        data:
          topic: "homeassistant/switch/{{ node }}_relay3/config"
          retain: true
          payload: >
            {
              "name": "{{ r3 }}",
              "unique_id": "{{ node }}_output40",
              "command_topic": "{{ base }}/command/output40",
              "state_topic":   "{{ base }}/state/output40",
              "value_template": "{{'{{ value_json.state }}'}}",
              "payload_on":  "{\"state\":\"on\"}",
              "payload_off": "{\"state\":\"off\"}",
              "state_on": "on",
              "state_off": "off",
              "optimistic": true,
              "device": {
                "identifiers": ["{{ dev_ident }}"],
                "name": "openHASP {{ node }}",
                "manufacturer": "openHASP",
                "model": "ESP32-S3 480x480"
              }
            }
